<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–£—á–µ–±–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</title>
    <style>
      :root {
        --bg: #0a0118;
        --glass: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.08);
        --accent: #a855f7;
        --accent-glow: rgba(168, 85, 247, 0.3);
        --text: #f3f4f6;
        --text-muted: #9ca3af;
      }

      * {
        box-sizing: border-box;
        transition: all 0.2s ease;
      }

      body {
        margin: 0;
        font-family: 'Inter', system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: 280px;
        backdrop-filter: blur(12px);
        background: var(--glass);
        border-right: 1px solid var(--border);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .logo {
        font-weight: 700;
        font-size: 18px;
        color: var(--accent);
      }

      h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: var(--text-muted);
      }

      .input,
      .textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
        font-size: 13px;
        outline: none;
      }
      .input:focus,
      .textarea:focus,
      select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 10px var(--accent-glow);
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent);
        color: #fff;
        box-shadow: 0 0 15px var(--accent-glow);
      }
      .btn:hover {
        filter: brightness(1.2);
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
        border: 1px solid var(--border);
        box-shadow: none;
      }

      .deck-list {
        list-style: none;
        margin: 0;
        padding: 0;
        overflow-y: auto;
        max-height: 45vh;
      }
      .deck-item {
        padding: 10px 12px;
        border-radius: 10px;
        margin-bottom: 6px;
        background: rgba(255, 255, 255, 0.02);
        cursor: pointer;
      }
      .deck-item:hover {
        border: 1px solid var(--accent);
        box-shadow: 0 0 10px var(--accent-glow);
      }
      .deck-item.active {
        background: rgba(168, 85, 247, 0.12);
        border: 1px solid var(--accent);
      }
      .deck-item-title {
        font-weight: 600;
        font-size: 14px;
      }
      .deck-item-desc {
        font-size: 12px;
        color: var(--text-muted);
      }

      /* Main */
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px 30px;
        overflow: hidden;
      }
      .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .deck-title {
        font-size: 20px;
        font-weight: 600;
      }
      .mode-switch {
        display: flex;
        border-radius: 999px;
        border: 1px solid var(--border);
        overflow: hidden;
      }
      .mode-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        padding: 8px 14px;
        font-size: 13px;
        cursor: pointer;
      }
      .mode-btn.active {
        background: var(--accent);
        color: #fff;
      }

      /* Cards & Study */
      .card-form,
      .study-card {
        backdrop-filter: blur(20px);
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(168, 85, 247, 0.08);
        margin-bottom: 14px;
      }
      .study-card-inner {
        text-align: center;
        min-height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 10px;
      }
      .study-label {
        font-size: 12px;
        color: var(--text-muted);
        letter-spacing: 0.08em;
      }
      .study-text {
        font-size: 17px;
        white-space: pre-wrap;
      }
      .study-actions {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        border-bottom: 1px solid var(--border);
        padding: 8px;
        text-align: left;
      }
      th {
        color: var(--text-muted);
        font-size: 12px;
      }

      .search-bar {
        margin-bottom: 10px;
      }

      .empty-state {
        text-align: center;
        color: var(--text-muted);
        margin-top: 16px;
      }

      /* –í–∞—Ä–∏–∞–Ω—Ç—ã –≤ —Ç–µ—Å—Ç–∞—Ö */
      .option-list {
        margin-top: 8px;
        max-width: 600px;
        margin-inline: auto;
        text-align: left;
      }
      .option-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-bottom: 4px;
        font-size: 14px;
      }
      .option-item input {
        margin: 0;
      }
      .opt-correct {
        border-color: #16a34a;
        background: rgba(22, 163, 74, 0.12);
      }
      .opt-incorrect {
        border-color: #b91c1c;
        background: rgba(185, 28, 28, 0.12);
      }
      .opt-missed {
        border-color: #eab308;
        background: rgba(234, 179, 8, 0.12);
      }

      /* –†–µ–¥–∞–∫—Ç–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ */
      .option-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }
      .option-row .option-text {
        flex: 1;
      }

      .toast-container {
        position: fixed;
        right: 20px;
        bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .toast {
        background: rgba(20, 10, 30, 0.9);
        border: 1px solid var(--accent);
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 13px;
        box-shadow: 0 0 20px var(--accent-glow);
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.25s ease, transform 0.25s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      @media (max-width: 800px) {
        body {
          flex-direction: column;
          height: auto;
        }
        .sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
      }

      .field {
        position: relative;
      }
      .field .icon-btn {
        position: absolute;
        right: 8px;
        bottom: 8px;
        border: none;
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 13px;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .field .icon-btn:hover {
        box-shadow: 0 0 10px var(--accent-glow);
        border-color: var(--accent);
      }
      .field .thumb {
        position: absolute;
        right: 8px;
        bottom: 42px;
        width: 36px;
        height: 36px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.25);
        display: none;
        overflow: hidden;
      }
      .field .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .field .thumb .x {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #0009;
        color: #fff;
        font-size: 10px;
        border-radius: 999px;
        padding: 2px 6px;
        border: 1px solid var(--border);
        cursor: pointer;
      }

      .study-img {
        margin-top: 10px;
        max-width: 100%;
        max-height: 320px;
        border-radius: 12px;
        border: 1px solid var(--border);
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
    </style>
  </head>

  <body>
    <aside class="sidebar">
      <div class="logo">–£—á–µ–±–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</div>

      <div>
        <h3>–ù–æ–≤–∞—è –∫–æ–ª–æ–¥–∞</h3>
        <input
          id="deckTitleInput"
          class="input"
          placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã"
        />
        <input
          id="deckDescInput"
          class="input"
          placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
          style="margin-top: 6px"
        />
        <input
          id="deckExamInput"
          class="input"
          type="date"
          style="margin-top: 6px"
        />
        <button id="createDeckBtn" class="btn" style="margin-top: 8px">
          + –°–æ–∑–¥–∞—Ç—å
        </button>
      </div>

      <div>
        <h3>–ö–æ–ª–æ–¥—ã</h3>
        <ul class="deck-list"></ul>
      </div>

      <div>
        <button
          id="exportBtn"
          class="btn-secondary btn"
          style="width: 100%; margin-top: 10px"
        >
          ‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON
        </button>
        <button
          id="importBtn"
          class="btn-secondary btn"
          style="width: 100%; margin-top: 6px"
        >
          ‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç JSON
        </button>
      </div>
    </aside>

    <main class="main">
      <div class="main-header">
        <div>
          <div class="deck-title">–£—á–µ–±–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</div>
          <div
            id="deckExamInfo"
            style="font-size: 12px; color: var(--text-muted); margin-top: 4px"
          ></div>
        </div>
        <div class="mode-switch">
          <button class="mode-btn active">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="mode-btn">–£—á–∏—Ç—å</button>
        </div>
      </div>

      <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
      <section id="manageSection">
        <div class="card-form">
          <h3>–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞</h3>
          <div class="field" id="frontField" data-img="">
            <textarea
              id="cardFrontInput"
              class="textarea"
              rows="2"
              placeholder="–í–æ–ø—Ä–æ—Å..."
            ></textarea>
            <div class="thumb" id="frontThumb">
              <img alt="front" />
              <span class="x" data-target="front">√ó</span>
            </div>
            <button type="button" class="icon-btn" id="frontImgBtn">üì∑</button>
            <input
              id="frontImgFile"
              type="file"
              accept="image/*"
              style="display: none"
            />
          </div>

          <div class="field" id="backField" data-img="" style="margin-top: 8px">
            <textarea
              id="cardBackInput"
              class="textarea"
              rows="2"
              placeholder="–û—Ç–≤–µ—Ç..."
            ></textarea>
            <div class="thumb" id="backThumb">
              <img alt="back" />
              <span class="x" data-target="back">√ó</span>
            </div>
            <button type="button" class="icon-btn" id="backImgBtn">üì∑</button>
            <input
              id="backImgFile"
              type="file"
              accept="image/*"
              style="display: none"
            />
          </div>

          <div style="margin-top: 8px">
            <select id="cardTypeSelect" class="input">
              <option value="basic">–û–±—ã—á–Ω–∞—è (–≤–æ–ø—Ä–æ—Å / –æ—Ç–≤–µ—Ç)</option>
              <option value="single">–¢–µ—Å—Ç (–æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç)</option>
            </select>
          </div>
          <div id="optionsEditor" style="margin-top: 8px; display: none">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 4px;
              "
            >
              <span style="font-size: 12px; color: var(--text-muted)">
                –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞
              </span>
              <button
                type="button"
                id="addOptionBtn"
                class="btn btn-secondary"
                style="padding: 4px 10px; font-size: 12px"
              >
                + –í–∞—Ä–∏–∞–Ω—Ç
              </button>
            </div>
            <div id="optionsList"></div>
            <p
              style="font-size: 11px; color: var(--text-muted); margin-top: 4px"
            >
              –î–æ–±–∞–≤—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ –æ—Ç–º–µ—Ç—å –æ–¥–∏–Ω –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.
            </p>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 10px">
            <button class="btn" id="saveCardBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button
              class="btn btn-secondary"
              id="cancelEditBtn"
              style="display: none"
            >
              –û—Ç–º–µ–Ω–∏—Ç—å
            </button>
          </div>
        </div>

        <div class="card-list">
          <div class="search-bar">
            <input
              class="input"
              placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –∏–ª–∏ –æ—Ç–≤–µ—Ç–∞–º..."
            />
          </div>
          <table>
            <thead>
              <tr>
                <th>–í–æ–ø—Ä–æ—Å</th>
                <th>–û—Ç–≤–µ—Ç</th>
                <th>–ò–Ω—Ç–µ—Ä–≤–∞–ª</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="empty-state">–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É üëÜ</div>
        </div>
      </section>

      <!-- –†–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è -->
      <section id="studySection" style="display: none">
        <div class="study-card">
          <div class="study-card-inner">
            <div class="study-label">–í–æ–ø—Ä–æ—Å</div>
            <div class="study-text">–í—ã–±–µ—Ä–∏ –∫–æ–ª–æ–¥—É –∏ –Ω–∞–∂–º–∏ ¬´–£—á–∏—Ç—å¬ª.</div>
            <div id="optionsContainer" class="option-list"></div>
          </div>
          <div class="study-actions"></div>
        </div>
      </section>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
      const STORAGE_KEY = 'flashcards_pro_violet';

      let state = {
        decks: [],
        selectedDeckId: null,
        mode: 'manage',
        studyQueue: [],
        studyIndex: 0,
        studyShowAnswer: false,
        stats: { streak: 0, studiedToday: 0, lastDate: null },
      };

      const uid = (p = 'id') =>
        p + '_' + Math.random().toString(36).slice(2, 9);
      const save = () =>
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      const load = () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          Object.assign(state, JSON.parse(raw));
        } catch (e) {}
      };

      function showToast(msg) {
        const box = document.createElement('div');
        box.className = 'toast';
        box.textContent = msg;
        document.getElementById('toastContainer').appendChild(box);
        setTimeout(() => box.classList.add('show'), 10);
        setTimeout(() => {
          box.classList.remove('show');
          setTimeout(() => box.remove(), 300);
        }, 2500);
      }

      function nextInterval(card, knew) {
        if (knew) {
          card.reps = (card.reps || 0) + 1;
          if (card.reps === 1) card.interval = 1;
          else if (card.reps === 2) card.interval = 3;
          else card.interval = Math.round(card.interval * 2.2);
        } else {
          card.reps = 0;
          card.lapses = (card.lapses || 0) + 1;
          card.interval = 1;
        }
        card.due = Date.now() + card.interval * 24 * 60 * 60 * 1000;
      }

      function currentDeck() {
        return state.decks.find((d) => d.id === state.selectedDeckId);
      }

      function formatExamBadge(deck) {
        if (!deck.examDate) return '';
        const exam = new Date(deck.examDate);
        const today = new Date();
        exam.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        const diffMs = exam - today;
        const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
        if (diffDays < 0) return ' ¬∑ —ç–∫–∑–∞–º–µ–Ω –ø—Ä–æ—à—ë–ª';
        if (diffDays === 0) return ' ¬∑ —ç–∫–∑–∞–º–µ–Ω —Å–µ–≥–æ–¥–Ω—è';
        if (diffDays === 1) return ' ¬∑ —ç–∫–∑–∞–º–µ–Ω –∑–∞–≤—Ç—Ä–∞';
        return ` ¬∑ —ç–∫–∑–∞–º–µ–Ω —á–µ—Ä–µ–∑ ${diffDays} –¥–Ω.`;
      }

      function highlight(text, q) {
        if (!q) return text;
        const r = new RegExp(
          `(${q.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')})`,
          'gi'
        );
        return text.replace(
          r,
          '<mark style="background:rgba(168,85,247,0.4);color:#fff;border-radius:3px;">$1</mark>'
        );
      }

      function refreshOptionsEditorVisibility() {
        const select = document.getElementById('cardTypeSelect');
        const editor = document.getElementById('optionsEditor');
        editor.style.display = select.value === 'single' ? 'block' : 'none';
      }

      function clearOptionsEditor() {
        const list = document.getElementById('optionsList');
        if (list) list.innerHTML = '';
      }
      // === Images via inline icons ===
      function readFileAsDataURL(file) {
        return new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
      }

      function setFieldImage(which, dataURL) {
        const field = document.getElementById(
          which === 'front' ? 'frontField' : 'backField'
        );
        const thumb = document.getElementById(
          which === 'front' ? 'frontThumb' : 'backThumb'
        );
        const img = thumb.querySelector('img');
        if (dataURL) {
          field.dataset.img = dataURL;
          img.src = dataURL;
          thumb.style.display = 'block';
        } else {
          field.dataset.img = '';
          img.src = '';
          thumb.style.display = 'none';
        }
      }

      function getFormImages() {
        const front = document.getElementById('frontField').dataset.img || null;
        const back = document.getElementById('backField').dataset.img || null;
        return {
          frontImg: front && front.startsWith('data:') ? front : null,
          backImg: back && back.startsWith('data:') ? back : null,
        };
      }

      function clearFormImagesInline() {
        setFieldImage('front', null);
        setFieldImage('back', null);
        document.getElementById('frontImgFile').value = '';
        document.getElementById('backImgFile').value = '';
      }

      function addOptionRow(option = null) {
        const list = document.getElementById('optionsList');
        if (!list) return;
        const row = document.createElement('div');
        row.className = 'option-row';
        row.dataset.id = option?.id || uid('opt');

        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.className = 'input option-text';
        textInput.placeholder = '–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞';
        textInput.value = option?.text || '';

        const label = document.createElement('label');
        label.style.fontSize = '11px';
        label.style.color = 'var(--text-muted)';
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'correctOptionEditor';
        radio.checked = !!option?.correct;
        label.appendChild(radio);
        label.appendChild(document.createTextNode(' –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π'));

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-secondary';
        removeBtn.style.padding = '4px 8px';
        removeBtn.textContent = '√ó';
        removeBtn.onclick = () => row.remove();

        row.appendChild(textInput);
        row.appendChild(label);
        row.appendChild(removeBtn);
        list.appendChild(row);
      }

      function renderDeckList() {
        const list = document.querySelector('.deck-list');
        list.innerHTML = '';
        if (!state.decks.length) {
          list.innerHTML = "<div class='deck-item'>–ù–µ—Ç –∫–æ–ª–æ–¥</div>";
          return;
        }
        state.decks.forEach((d) => {
          const li = document.createElement('li');
          li.className =
            'deck-item' + (d.id === state.selectedDeckId ? ' active' : '');
          li.innerHTML = `
            <div class="deck-item-title">${d.title}</div>
            <div class="deck-item-desc">
              ${d.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'} ¬∑ ${
            d.cards.length
          } —à—Ç.${formatExamBadge(d)}
            </div>`;
          li.onclick = () => {
            state.selectedDeckId = d.id;
            state.mode = 'manage';
            save();
            renderAll();
          };
          list.appendChild(li);
        });
      }

      function renderHeader() {
        const deck = currentDeck();
        const titleEl = document.querySelector('.deck-title');
        const examInfoEl = document.getElementById('deckExamInfo');

        if (deck) {
          titleEl.textContent = deck.title;
          if (deck.examDate) {
            const badge = formatExamBadge(deck);
            examInfoEl.textContent =
              '–≠–∫–∑–∞–º–µ–Ω: ' + deck.examDate + badge.replace(' ¬∑', ' ¬∑');
          } else {
            examInfoEl.textContent = '';
          }
        } else {
          titleEl.textContent = '–£—á–µ–±–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏';
          if (examInfoEl) examInfoEl.textContent = '';
        }

        document.querySelectorAll('.mode-btn').forEach((btn) => {
          btn.classList.remove('active');
          if (
            (btn.textContent.includes('–†–µ–¥') && state.mode === 'manage') ||
            (btn.textContent.includes('–£—á') && state.mode === 'study')
          )
            btn.classList.add('active');
        });
      }

      function renderCards() {
        const deck = currentDeck();
        const tbody = document.querySelector('tbody');
        const empty = document.querySelector('.empty-state');
        tbody.innerHTML = '';
        if (!deck) {
          empty.style.display = 'block';
          empty.textContent = '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –∏ –≤—ã–±–µ—Ä–∏ –∫–æ–ª–æ–¥—É';
          return;
        }
        const q = document
          .querySelector('.search-bar input')
          .value.toLowerCase();
        let cards = deck.cards.filter((c) => {
          const f = (c.front || '').toLowerCase();
          const b = (c.back || '').toLowerCase();
          return f.includes(q) || b.includes(q);
        });

        if (!cards.length) {
          empty.style.display = 'block';
          empty.textContent = '–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–ª–∏ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π';
          return;
        }
        empty.style.display = 'none';
        cards.forEach((c) => {
          const tr = document.createElement('tr');

          const frontCell = c.front?.trim()
            ? highlight(c.front, q)
            : c.frontImg
            ? 'üñºÔ∏è –§–æ—Ç–æ'
            : "<span style='color:var(--text-muted)'>‚Äî</span>";

          const backCell = c.back?.trim()
            ? highlight(c.back, q)
            : c.backImg
            ? 'üñºÔ∏è –§–æ—Ç–æ'
            : "<span style='color:var(--text-muted)'>‚Äî</span>";

          const typeLabel =
            (c.type === 'single' ? ' (—Ç–µ—Å—Ç)' : '') +
            (c.frontImg || c.backImg ? ' üì∑' : '');

          tr.innerHTML = `
          <td>${frontCell}</td>
          <td>${backCell}${typeLabel}</td>
          <td>${c.interval || 0} –¥–Ω.</td>
          <td>
            <button class="btn-secondary btn" style="padding:4px 8px;" onclick="editCard('${
              c.id
            }')">–ò–∑–º.</button>
            <button class="btn-secondary btn" style="padding:4px 8px;color:#f87171;border-color:#f87171;" onclick="deleteCard('${
              c.id
            }')">‚úï</button>
          </td>`;

          tbody.appendChild(tr);
        });
      }

      function editCard(id) {
        const deck = currentDeck();
        if (!deck) return;
        const c = deck.cards.find((x) => x.id === id);
        if (!c) return;
        document.getElementById('cardFrontInput').value = c.front;
        document.getElementById('cardBackInput').value = c.back;
        document.getElementById('cardTypeSelect').value = c.type || 'basic';
        setFieldImage('front', c.frontImg || null);
        setFieldImage('back', c.backImg || null);
        document.getElementById('frontImgFile').value = '';
        document.getElementById('backImgFile').value = '';

        refreshOptionsEditorVisibility();
        clearOptionsEditor();
        if (c.type === 'single' && Array.isArray(c.options)) {
          c.options.forEach((opt) => addOptionRow(opt));
        }
        const form = document.querySelector('.card-form');
        form.dataset.edit = id;
        document.getElementById('saveCardBtn').textContent =
          '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
      }

      function cancelEdit() {
        const form = document.querySelector('.card-form');
        delete form.dataset.edit;
        document.getElementById('cardFrontInput').value = '';
        document.getElementById('cardBackInput').value = '';
        document.getElementById('cardTypeSelect').value = 'basic';
        clearOptionsEditor();
        refreshOptionsEditorVisibility();
        document.getElementById('saveCardBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        document.getElementById('cancelEditBtn').style.display = 'none';
        showToast('‚ùå –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
        clearFormImagesInline(); // üëà —É–±–∏—Ä–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã –∏ –æ—á–∏—â–∞–µ–º file-–∏–Ω–ø—É—Ç—ã
      }

      function deleteCard(id) {
        const deck = currentDeck();
        if (!deck) return;
        deck.cards = deck.cards.filter((c) => c.id !== id);
        save();
        renderCards();
        showToast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
      }

      function saveCard() {
        const deck = currentDeck();

        if (!deck) {
          showToast('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –∫–æ–ª–æ–¥—É');
          return;
        }
        const { frontImg, backImg } = getFormImages();
        const front = document.getElementById('cardFrontInput').value.trim();
        const back = document.getElementById('cardBackInput').value.trim();
        const type = document.getElementById('cardTypeSelect').value;

        // —Ç–µ–ø–µ—Ä—å –¥–æ–ø—É—Å–∫–∞–µ–º: —Ç–µ–∫—Å—Ç –ò–õ–ò —Ñ–æ—Ç–æ –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
        const frontOK = !!front || !!frontImg;
        const backOK = !!back || !!backImg;
        if (!frontOK || !backOK) {
          showToast('–ù—É–∂–µ–Ω —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ');
          return;
        }

        let options = [];
        if (type === 'single') {
          const rows = Array.from(
            document.querySelectorAll('#optionsList .option-row')
          );
          if (rows.length < 2) {
            showToast('–î–ª—è —Ç–µ—Å—Ç–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞');
            return;
          }
          rows.forEach((row) => {
            const textInput = row.querySelector('.option-text');
            const radio = row.querySelector("input[type='radio']");
            const text = textInput.value.trim();
            if (!text) return;
            options.push({
              id: row.dataset.id || uid('opt'),
              text,
              correct: radio.checked,
            });
          });
          const hasCorrect = options.some((o) => o.correct);
          if (!hasCorrect) {
            showToast('–û—Ç–º–µ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç');
            return;
          }
        }

        const form = document.querySelector('.card-form');
        const editId = form.dataset.edit;
        if (editId) {
          const c = deck.cards.find((x) => x.id === editId);
          Object.assign(c, {
            front,
            back,
            type,
            options: type === 'single' ? options : [],
            frontImg, // üëà –¥–æ–±–∞–≤–∏–ª–∏
            backImg, // üëà –¥–æ–±–∞–≤–∏–ª–∏
          });

          delete form.dataset.edit;
        } else {
          deck.cards.push({
            id: uid('card'),
            front,
            back,
            type,
            options: type === 'single' ? options : [],
            frontImg, // üëà –¥–æ–±–∞–≤–∏–ª–∏
            backImg, // üëà –¥–æ–±–∞–≤–∏–ª–∏
            createdAt: Date.now(),
            interval: 0,
            reps: 0,
            due: Date.now(),
          });
        }

        document.getElementById('cardFrontInput').value = '';
        document.getElementById('cardBackInput').value = '';
        document.getElementById('cardTypeSelect').value = 'basic';
        clearOptionsEditor();
        refreshOptionsEditorVisibility();
        document.getElementById('saveCardBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        document.getElementById('cancelEditBtn').style.display = 'none';

        save();
        renderCards();
        showToast('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        clearFormImagesInline();
      }

      function renderOptionsForStudy(card) {
        const container = document.getElementById('optionsContainer');
        container.innerHTML = '';
        if (!card.options || !card.options.length) return;
        card.options.forEach((opt) => {
          const item = document.createElement('label');
          item.className = 'option-item';
          item.dataset.id = opt.id;
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'studyOption';
          const span = document.createElement('span');
          span.textContent = opt.text;
          item.appendChild(input);
          item.appendChild(span);
          container.appendChild(item);
        });
      }

      function renderStudy() {
        const deck = currentDeck();
        const lbl = document.querySelector('.study-label');
        const txt = document.querySelector('.study-text');
        const btns = document.querySelector('.study-actions');
        const optionsContainer = document.getElementById('optionsContainer');

        if (!deck || !state.studyQueue.length) {
          lbl.textContent = '–í–æ–ø—Ä–æ—Å';
          txt.textContent = '–í—ã–±–µ—Ä–∏ –∫–æ–ª–æ–¥—É –∏ –Ω–∞–∂–º–∏ ¬´–£—á–∏—Ç—å¬ª.';
          optionsContainer.innerHTML = '';
          btns.innerHTML = '';
          return;
        }

        const card = state.studyQueue[state.studyIndex];
        if (!card) {
          lbl.textContent = '–ì–æ—Ç–æ–≤–æ';
          txt.textContent = '–í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω—ã ‚úÖ';
          optionsContainer.innerHTML = '';
          btns.innerHTML = '';
          return;
        }

        const isTest = card.type === 'single' && card.options?.length;

        if (isTest) {
          if (!state.studyShowAnswer) {
            lbl.textContent = '–¢–µ—Å—Ç (–æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç)';
            const sideText = state.studyShowAnswer
              ? card.back || ''
              : card.front || '';
            txt.innerHTML = sideText ? marked.parse(sideText) : '';
            MathJax.typesetPromise();

            // —É–±—Ä–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const old = document.getElementById('studyDynamicImg');
            if (old) old.remove();

            const imgToShow = state.studyShowAnswer
              ? card.backImg || null
              : card.frontImg || null;

            if (imgToShow) {
              const img = document.createElement('img');
              img.id = 'studyDynamicImg';
              img.className = 'study-img';
              img.src = imgToShow;
              txt.parentElement.appendChild(img);
            }

            renderOptionsForStudy(card);
            btns.innerHTML =
              '<button class="btn" onclick="checkTest()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>';
          } else {
            lbl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞';
            const sideText = state.studyShowAnswer
              ? card.back || ''
              : card.front || '';
            txt.innerHTML = sideText ? marked.parse(sideText) : '';
            MathJax.typesetPromise();

            // —É–±—Ä–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const old = document.getElementById('studyDynamicImg');
            if (old) old.remove();

            const imgToShow = state.studyShowAnswer
              ? card.backImg || null
              : card.frontImg || null;

            if (imgToShow) {
              const img = document.createElement('img');
              img.id = 'studyDynamicImg';
              img.className = 'study-img';
              img.src = imgToShow;
              txt.parentElement.appendChild(img);
            }

            MathJax.typesetPromise();
            btns.innerHTML =
              '<button class="btn" onclick="rate(true)">–ó–Ω–∞–ª</button>' +
              '<button class="btn btn-secondary" onclick="rate(false)">–ù–µ –∑–Ω–∞–ª</button>';
          }
        } else {
          optionsContainer.innerHTML = '';
          lbl.textContent = state.studyShowAnswer ? '–û—Ç–≤–µ—Ç' : '–í–æ–ø—Ä–æ—Å';
          const sideText = state.studyShowAnswer
            ? card.back || ''
            : card.front || '';
          txt.innerHTML = sideText ? marked.parse(sideText) : '';
          MathJax.typesetPromise();

          txt.innerHTML = marked.parse(
            state.studyShowAnswer ? card.back : card.front
          );
          // —É–±—Ä–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          const old = document.getElementById('studyDynamicImg');
          if (old) old.remove();

          const imgToShow = state.studyShowAnswer
            ? card.backImg || null
            : card.frontImg || null;

          if (imgToShow) {
            const img = document.createElement('img');
            img.id = 'studyDynamicImg';
            img.className = 'study-img';
            img.src = imgToShow;
            txt.parentElement.appendChild(img);
          }

          MathJax.typesetPromise();
          btns.innerHTML = state.studyShowAnswer
            ? '<button class="btn btn-secondary" onclick="backToQuestion()">‚Üê –ù–∞–∑–∞–¥</button>' +
              '<button class="btn" onclick="rate(true)">–ó–Ω–∞–ª</button>' +
              '<button class="btn btn-secondary" onclick="rate(false)">–ù–µ –∑–Ω–∞–ª</button>'
            : '<button class="btn" onclick="showAns()">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>';
        }
      }

      function startStudy() {
        const deck = currentDeck();
        if (!deck || !deck.cards.length) {
          showToast('–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫');
          return;
        }
        const due = deck.cards.filter((c) => !c.due || c.due <= Date.now());
        if (!due.length) {
          showToast('–ù–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫, –≤—Å—ë –≤—ã—É—á–µ–Ω–æ!');
        }
        state.studyQueue = due.length ? due : deck.cards;
        state.studyIndex = 0;
        state.studyShowAnswer = false;
        state.mode = 'study';
        save();
        renderAll();
      }

      function showAns() {
        state.studyShowAnswer = true;
        renderStudy();
      }

      function checkTest() {
        const card = state.studyQueue[state.studyIndex];
        if (!card || !card.options?.length) return;
        const container = document.getElementById('optionsContainer');
        const items = Array.from(container.querySelectorAll('.option-item'));
        const selectedIds = items
          .filter((item) => item.querySelector('input').checked)
          .map((item) => item.dataset.id);

        if (!selectedIds.length) {
          showToast('–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç');
          return;
        }

        const correctIds = card.options
          .filter((o) => o.correct)
          .map((o) => o.id);

        items.forEach((item) => {
          const input = item.querySelector('input');
          const id = item.dataset.id;
          const isCorrect = correctIds.includes(id);
          item.classList.remove('opt-correct', 'opt-incorrect', 'opt-missed');
          input.disabled = true;
          if (isCorrect && input.checked) item.classList.add('opt-correct');
          else if (!isCorrect && input.checked)
            item.classList.add('opt-incorrect');
          else if (isCorrect && !input.checked)
            item.classList.add('opt-missed');
        });

        state.studyShowAnswer = true;
        renderStudy();
      }

      function rate(knew) {
        const card = state.studyQueue[state.studyIndex];
        if (!card) return;
        nextInterval(card, knew);
        state.stats.studiedToday = (state.stats.studiedToday || 0) + 1;
        const today = new Date().toDateString();
        if (state.stats.lastDate !== today) {
          state.stats.streak =
            state.stats.lastDate === null ? 1 : (state.stats.streak || 0) + 1;
          state.stats.lastDate = today;
        }
        state.studyIndex++;
        state.studyShowAnswer = false;
        save();
        renderAll();
      }

      function exportData() {
        const blob = new Blob([JSON.stringify(state.decks, null, 2)], {
          type: 'application/json',
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'flashcards.json';
        a.click();
      }

      function importData(file) {
        const r = new FileReader();
        r.onload = () => {
          try {
            const imported = JSON.parse(r.result);
            if (Array.isArray(imported)) {
              imported.forEach((deck) => {
                if (!state.decks.find((d) => d.title === deck.title))
                  state.decks.push(deck);
              });
              save();
              renderAll();
              showToast('üì¶ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
            }
          } catch (e) {
            showToast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
          }
        };
        r.readAsText(file);
      }

      function renderAll() {
        renderDeckList();
        renderHeader();
        renderCards();
        if (state.mode === 'study') renderStudy();

        const manage = document.getElementById('manageSection');
        const study = document.getElementById('studySection');
        if (manage && study) {
          manage.style.display = state.mode === 'manage' ? 'block' : 'none';
          study.style.display = state.mode === 'study' ? 'block' : 'none';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        load();
        renderAll();
        refreshOptionsEditorVisibility();

        document
          .getElementById('createDeckBtn')
          .addEventListener('click', () => {
            const titleInput = document.getElementById('deckTitleInput');
            const descInput = document.getElementById('deckDescInput');
            const examInput = document.getElementById('deckExamInput');

            const title = titleInput.value.trim();
            const desc = descInput.value.trim();
            const examDate = examInput.value;

            if (!title) {
              showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã');
              return;
            }

            const exists = state.decks.some(
              (d) => d.title.toLowerCase() === title.toLowerCase()
            );
            if (exists) {
              showToast('–ö–æ–ª–æ–¥–∞ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ –µ—Å—Ç—å');
              return;
            }

            const newDeck = {
              id: uid('deck'),
              title,
              description: desc,
              cards: [],
              examDate: examDate || null,
            };

            state.decks.push(newDeck);
            state.selectedDeckId = newDeck.id;

            titleInput.value = '';
            descInput.value = '';
            examInput.value = '';

            save();
            renderAll();
            showToast('‚ú® –ö–æ–ª–æ–¥–∞ —Å–æ–∑–¥–∞–Ω–∞');
          });

        // --- Inline image buttons handlers ---
        document.getElementById('frontImgBtn').addEventListener('click', () => {
          document.getElementById('frontImgFile').click();
        });
        document.getElementById('backImgBtn').addEventListener('click', () => {
          document.getElementById('backImgFile').click();
        });

        document
          .getElementById('frontImgFile')
          .addEventListener('change', async (e) => {
            const f = e.target.files?.[0];
            if (!f) return;
            if (!f.type.startsWith('image/')) {
              showToast('–ù—É–∂–µ–Ω —Ñ–∞–π–ª-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
              return;
            }
            setFieldImage('front', await readFileAsDataURL(f));
          });
        document
          .getElementById('backImgFile')
          .addEventListener('change', async (e) => {
            const f = e.target.files?.[0];
            if (!f) return;
            if (!f.type.startsWith('image/')) {
              showToast('–ù—É–∂–µ–Ω —Ñ–∞–π–ª-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
              return;
            }
            setFieldImage('back', await readFileAsDataURL(f));
          });

        // –ö—Ä–µ—Å—Ç–∏–∫–∏ –Ω–∞ –º–∏–Ω–∏-–ø—Ä–µ–≤—å—é
        document.querySelectorAll('.thumb .x').forEach((x) => {
          x.addEventListener('click', () => {
            const t = x.dataset.target; // 'front' | 'back'
            setFieldImage(t, null);
            document.getElementById(
              t === 'front' ? 'frontImgFile' : 'backImgFile'
            ).value = '';
          });
        });

        document
          .getElementById('saveCardBtn')
          .addEventListener('click', saveCard);
        document
          .getElementById('cancelEditBtn')
          .addEventListener('click', cancelEdit);

        document
          .getElementById('cardTypeSelect')
          .addEventListener('change', refreshOptionsEditorVisibility);
        document
          .getElementById('addOptionBtn')
          .addEventListener('click', () => addOptionRow());

        const modeBtns = document.querySelectorAll('.mode-btn');
        modeBtns[0].onclick = () => {
          state.mode = 'manage';
          renderAll();
        };
        modeBtns[1].onclick = startStudy;

        document.querySelector('.search-bar input').oninput = renderCards;

        document.getElementById('exportBtn').onclick = exportData;
        document.getElementById('importBtn').onclick = () => {
          const f = document.createElement('input');
          f.type = 'file';
          f.accept = '.json';
          f.onchange = (e) => importData(e.target.files[0]);
          f.click();
        };

        document.addEventListener('keydown', (e) => {
          if (state.mode === 'study') {
            if (e.code === 'Space') {
              e.preventDefault();
              if (!state.studyShowAnswer) showAns();
            }
            if (e.key === '1') rate(true);
            if (e.key === '2') rate(false);
          }
          if (state.mode === 'study' && state.studyShowAnswer) {
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'b') {
              e.preventDefault();
              backToQuestion();
            }
          }
          if (e.ctrlKey && e.key === 'Enter') saveCard();
        });
      });

      function resetTestSelections() {
        const container = document.getElementById('optionsContainer');
        if (!container) return;
        container.querySelectorAll('.option-item').forEach((item) => {
          item.classList.remove('opt-correct', 'opt-incorrect', 'opt-missed');
          const input = item.querySelector('input');
          if (input) {
            input.checked = false;
            input.disabled = false;
          }
        });
      }

      function backToQuestion() {
        state.studyShowAnswer = false;
        resetTestSelections(); // –¥–ª—è —Ç–µ—Å—Ç–æ–≤: –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É –∏ —Å–Ω–æ–≤–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—ã–±–æ—Ä
        renderStudy();
      }
    </script>
  </body>
</html>
